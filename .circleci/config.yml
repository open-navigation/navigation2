version: 2.1
references:
  install_upstream: &install_upstream
    run:
        name: Install Upstream
        command: |
          mkdir -p $ROS_WS/src
          vcs import $ROS_WS/src < $NAV2_WS/src/navigation2/tools/ros2_dependencies.repos
          find $ROS_WS/src -not -iwholename '*.git/*' -type f -exec sha256sum {} \; | \
            sort -k 2 | \
            cut -d" " -f1 | \
            sha256sum | \
            awk '{print "source "$1}' >> $ROS_WS/checksum.txt
          apt-get update
          dependencies=$(
            rosdep install -q -y \
              --from-paths \
                $ROS_WS/src \
              --ignore-src \
              --verbose | \
            awk '$1 ~ /^resolution\:/' | \
            awk -F'[][]' '{print $2}' | \
            tr -d \, | xargs -n1 | sort -u | xargs)
          dpkg -s $dependencies | \
            sha256sum | \
            awk '{print "dependencies "$1}' >> $ROS_WS/checksum.txt
  restore_upstream_cache: &restore_upstream_cache
    restore_cache:
      name: Restore Upstream Cache
      key: upstream-cache-v1-{{ arch }}-{{ .Branch }}-{{ checksum "/opt/ros_ws/checksum.txt" }}
  build_upstream: &build_upstream
    run:
      name: Build Upstream
      command: |
        cd $ROS_WS
        if [ -d install ]
        then
            echo "Skipping Build Upstream"
        else
            . /opt/ros/$ROS_DISTRO/setup.sh
            colcon build \
              --symlink-install
        fi
  save_upstream_cache: &save_upstream_cache
    save_cache:
      name: Save Upstream Cache
      key: upstream-cache-v1-{{ arch }}-{{ .Branch }}-{{ checksum "/opt/ros_ws/checksum.txt" }}
      paths:
        - /opt/ros_ws
  install_dependencies: &install_dependencies
    run:
        name: Install Dependencies
        command: |
          cat $ROS_WS/checksum.txt | \
            sha256sum | \
            awk '{print "upstream "$1}' >> $NAV2_WS/checksum.txt
          find $NAV2_WS/src -not -iwholename '*.git/*' -type f -exec sha256sum {} \; | \
            sort -k 2 | \
            cut -d" " -f1 | \
            sha256sum | \
            awk '{print "source "$1}' >> $NAV2_WS/checksum.txt
          apt-get update
          dependencies=$(
            rosdep install -q -y \
              --from-paths \
                $ROS_WS/src \
                src \
              --ignore-src \
              --verbose | \
            awk '$1 ~ /^resolution\:/' | \
            awk -F'[][]' '{print $2}' | \
            tr -d \, | xargs -n1 | sort -u | xargs)
          dpkg -s $dependencies | \
            sha256sum | \
            awk '{print "dependencies "$1}' >> $NAV2_WS/checksum.txt
  restore_navigation2_cache: &restore_navigation2_cache
    restore_cache:
      name: Restore Navigation2 Cache
      key: navigation2-cache-v1-{{ arch }}-{{ .Branch }}-{{ checksum "/opt/nav2_ws/checksum.txt" }}
  build_navigation2: &build_navigation2
    run:
      name: Build Navigation2
      command: |
        if [ -d install ]
        then
            echo "Skipping Build Navigation2"
        else
            . $ROS_WS/install/setup.sh
            colcon build \
              --symlink-install
        fi
  save_navigation2_cache: &save_navigation2_cache
    save_cache:
      name: Save Navigation2 Cache
      key: navigation2-cache-v1-{{ arch }}-{{ .Branch }}-{{ checksum "/opt/nav2_ws/checksum.txt" }}
      paths:
        - /opt/nav2_ws
  copy_build_logs: &copy_build_logs
    run:
        name: Copy Build Logs
        when: always
        command: cp -rH log/latest_build log/build
  store_build_logs: &store_build_logs
    store_artifacts:
        path: log/build
  test_navigation2: &test_navigation2
    run:
        name: Test Navigation2
        command: |
          . install/setup.sh
          colcon test --packages-skip nav2_system_tests
          colcon test-result \
            --verbose
  copy_test_logs: &copy_test_logs
    run:
        name: Copy Test Logs
        when: always
        command: cp -rH log/latest_test log/test
  store_test_logs: &store_test_logs
    store_artifacts:
        path: log/test

commands:
  setup_upstream:
    description: "Setup Upstream"
    steps:
      - *install_upstream
      - *restore_upstream_cache
      - *build_upstream
      - *save_upstream_cache
  build_source:
    description: "Build Source"
    steps:
      - *install_dependencies
      - *restore_navigation2_cache
      - *build_navigation2
      - *save_navigation2_cache
      - *copy_build_logs
      - *store_build_logs
  test_source:
    description: "Test Source"
    steps:
      - *test_navigation2
      - *copy_test_logs
      - *store_test_logs

executors:
  navigation2_exec:
    docker:
      - image: ruffsl/navigation2:master
    working_directory: /opt/nav2_ws
    environment:
      CMAKE_BUILD_TYPE: "Release"
      MAKEFLAGS: "-j 1 -l 1"

jobs:
  build:
    executor: navigation2_exec
    steps:
      - run:
          name: Clean up Environment
          command: |
            rm -rf $ROS_WS/*
            rm -rf $NAV2_WS/*
      - checkout:
          path: src/navigation2
      - setup_upstream
      - build_source
      - test_source

workflows:
  version: 2
  build-test:
    jobs:
      - build
  # nightly:
  #   triggers:
  #     - schedule:
  #         cron: "0 0 * * *"
  #         filters:
  #           branches:
  #             only:
  #               - master
  #   jobs:
  #     - build
