# Snippet to reverse proxy websocket connections
# to direct backend traffic while hosting frontend
# E.g Use web apps from a forwarded port via CodeSpaces
(websockets) {
	# Matcher for websocket connection upgrade requests
	@{args.0}_websockets {
		# Avoid case sensitivity issues when matching field values
		# E.g. when values are rewritten by Codespace port forwarding
		header_regexp Connection (?i)(Upgrade)
		header Upgrade websocket
	}
	# Configure reverse proxy for web app to given backend address
	reverse_proxy @{args.0}_websockets {args.1}
}

# Snippet for global matchers and variables
# to logically expression request conditions
# E.g. for conditionally changing redirects
(globals) {
	# Matcher for index.html files
	@index_files {
		path /
	}

	# Matcher for http request scheme. E.g. "http" or "https"
	@http_scheme {
		expression {http.request.scheme}=="https" || {header.X-Forwarded-Scheme}=="https"
	}
	# If any http scheme is "https", then use "wss"
	vars @http_scheme WsScheme "wss"
	# Else default to "ws"
	vars WsScheme "ws"

	# Matcher for forwarded request headers
	@host_forwarded {
		header X-Forwarded-Host *
	}
	# If http headers exists, then use them
	vars @host_forwarded WsHost {header.X-Forwarded-Host}
	# Else default to host in request
	vars WsHost {http.request.hostport}
}

# Snippet for redirect with given URL queries values
# to simplify remote development with web apps
# E.g auto redirect websocket URL to match request scheme
(redirect) {
	# Configure redirect to match request scheme
	vars LayoutUrl "/assets/nav2_foxglove_layout.json"
	vars DataSourceUrl "{vars.WsScheme}://{vars.WsHost}{path.dir}"
	redir /{args.0}/nav2 /{args.0}/?ds=foxglove-websocket&ds.url={vars.DataSourceUrl}&layoutUrl={vars.LayoutUrl}
}

# Snippet for enabling mobile web app features
(mobile) {
	route @index_files {
		replace `<head>` `<head><meta name="apple-mobile-web-app-capable" content="yes"><meta name="mobile-web-app-capable" content="yes">`
	}
}

# Listen for http requests on port 8080
# regardless of hostname or domain address
# E.g. whatever Codespaces assigns to host
:8080 {
	# Include global matchers and variables
	import globals
	encode gzip

	handle /* {
		root * srv
		file_server
		templates
		import mobile
	}

	redir /gzweb /gzweb/
	handle_path /gzweb/* {
		root * /srv/gzweb
		file_server
		import mobile
		import websockets "gzweb" "localhost:9090"
	}

	redir /foxglove /foxglove/
	handle_path /foxglove/* {
		root * /srv/foxglove
		file_server
		import mobile
		import websockets "foxglove" "localhost:8765"
	}
	import redirect "foxglove"

	redir /glances /glances/
	handle_path /glances/* {
		import mobile
		reverse_proxy * "localhost:61208"
	}

	# For debugging
	# log {
	# 	output file /var/log/caddy/server.log
	# }
}
